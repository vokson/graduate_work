# Спринт 7 - Auth 2
https://github.com/vokson/Auth_sprint_2

## Переменные окружения
Создайте файл .env.prod и заполните его. Используйте .env.prod.example в качестве примера.

## Docker
Запустите Docker контейнеры:
```console
make up
```

Выполнить миграции:
```console
make migrate
```

Создать суперпользователя:
```console
make createsuperuser
```

## Сервис авторизации
API доступно по адресу:
- $HOST/auth/api/

## Сервис кинотеатра
[https://github.com/vokson/Async_API_sprint_2](https://github.com/vokson/Async_API_sprint_2)

API доступно по адресу:
- $HOST/movies/api/


# Проектная работа: диплом

Вопрос: непонятно зачем в кинотеатре загрузка файлов пользователями?

ИСТОРИЯ CDN SERVER
OPENAPI
DEPLOY YANDEX
лИШНИЕ env
README (UFW, IP FRONTEND)

##  Клиент (в данном случае фронтенд на VueJs)

1. Авторизуется через сервис Auth и получает access и refresh токены;
1. Выполняет операции
    - Получение списка файлов
    - Добавление файла
    - Удаление файла
    - Переименовывание файла
    - Получает историю действий пользователя
    - Создает ссылку для доступа к файлу
    - Удаляет ссылку для доступа к файлу

## Сервис Auth

Построен по событийно-ориентированной архитектуре с применением Fast API

## Сервис Storage

В качестве хранилищ данных используется 3 сервера Minio, которым по умолчанию расположены в городах Нью-Йорк, Владивосток и Кейптаун.
Опишу основные операции:

### Добавление файла
1. При добавлении файла определяется IP пользователя (в зависимости от настроек приложения может использоваться реальный или фэйковый IP).
1. По IP определяется геолокация и координаты широты и долготы.
1. Выбирается ближайший к пользователю сервер.
1. Сервис Storage обращается к данному S3 серверу и получает подписанную ссылку для загрузки файла.
1. Ссылка возвращаетcя клиенту в ответе API.
1. Клиент загружает файл по ссылке.
1. S3 сервер публикует сообщение в RabbitMQ о том, что файл загружен
1. Воркер S3_WORKER читает данное сообщение и эмитирует событие FILE.STORED в RabbitMQ
1. Воркер FILE_OPERATOR читает сообщение FILE.STORED
1. Воркер FILE_OPERATOR скачивает файл во временное хранилище
1. Воркер FILE_OPERATOR загружает файл на оставшиеся сервера
1. Воркер FILE_OPERATOR удаляет файл из временного хранилища

### Скачивание файла
1. При добавлении файла определяется IP пользователя (в зависимости от настроек приложения может использоваться реальный или фэйковый IP).
1. По IP определяется геолокация и координаты широты и долготы.
1. Выбирается ближайший к пользователю сервер.
1. Сервис Storage обращается к данному S3 серверу и получает подписанную ссылку для скачивания файла.
1. Ссылка возвращаетcя клиенту в ответе API.

### Удаление файла
1. При удалении файла он помечается в БД как удаленный.
1. В шину данных отправляется событие FILE.DELETED
1. Воркер FILE_OPERATOR читает сообщение FILE.DELETED
1. Воркер FILE_OPERATOR удаляет файлы со всех S3 серверов, на которых он раположен



## Вопросы
1. Нет никакой структуры папок. Список плоский
1. Ссылку на файл собираюсь формировать общедоступную на чтение с временем жизни и паролем, чтобы не тянуть пользователей из сервиса Auth
1. Нужно ли делать авторизацию через соц сети для сервиса Auth ?
1. При скачивании нужно ли определять наименее загруженный сервер ?

Помимо основного кода требуется добавить CI пайплайн в Github Actions, который содержит следующие элементы:
- Проверка кода линтером wemake-python-styleguide;
- Проверка типов методов и переменных через mypy;
- Запуск кода на версиях Python 3.8 и 3.9;
- Отчёт по проверке линтерами в формате HTML-файла;
- Отправка уведомления об успешности или неуспешности прохождения пайплайна в телеграм канал.

## Деплой на Яндекс.Облако
Залить сервис в облако
 - Обязательно ли?

 ## UML
![scheme](scheme.svg)


Масштабируемость при нагрузке
Добавление, удаление новых серверов.