from datetime import datetime
from uuid import UUID, uuid4

from fastapi import Depends

from src.db.storages import AsyncPostgresStorage, get_psql
from src.models.user import User


class AuthService:
    def __init__(self, db: AsyncPostgresStorage):
        self.db = db

    async def create_user(
        self,
        username: str,
        password: str,
    ) -> User:
        obj = {
            "id": uuid4(),
            "username": username
            "password": password,
            "created": datetime.now(),
            "modified": datetime.now(),
        }

        await self.db.save_event(**obj)  # type: ignore
        return User(**obj)  # type: ignore


def get_auth_service(
    db: AsyncPostgresStorage = Depends(get_psql),
) -> AuthService:
    return AuthService(db)